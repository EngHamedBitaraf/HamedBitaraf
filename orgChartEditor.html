<!--  html file display tree-->
  <!DOCTYPE html>
  <html lang="en">
  <body bgcolor="#92a8d1">
  <script type="text/javascript" src="qrc:/qwebchannel.js"></script>
  <script src="qrc:/go.js"></script>
  <script src="qrc:/jquery-3.6.0.min.js"></script>
  <div id="allSampleContent" class="p-4 w-full">

  <script id="code">
  new QWebChannel(qt.webChannelTransport, function (channel) {
      // all published objects are available in channel.objects under
      // the identifier set in their attached WebChannel.id property
           var jsonfile =channel.objects.foo;
          var dManager = channel.objects.bar;

          //myFullDiagram.model =new go.TreeModel(jsonfile.valueJson)

           jQuery.getJSON(jsonfile.filedata,function(data){
           myFullDiagram.model =new go.TreeModel(data)});

      });
    function init() {
      // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
      // For details, see https://gojs.net/latest/intro/buildingObjects.html
      const $ = go.GraphObject.make;  // for conciseness in defining templates


      myFullDiagram =
        $(go.Diagram, "myDiagramDiv", // must be the ID or reference to div
          {

            maxSelectionCount: 1, // users can select only one part at a time
            layout:
              $(go.TreeLayout,
                {
                  treeStyle: go.TreeLayout.StyleLastParents,
                  arrangement: go.TreeLayout.ArrangementHorizontal,
                  // properties for most of the tree:
                  angle: 90,
                  layerSpacing: 35,
                  // properties for the "last parents":
                  alternateAngle: 90,
                  alternateLayerSpacing: 35,
                  alternateAlignment: go.TreeLayout.AlignmentBus,
                  alternatePortSpot :new go.Spot(0.8,255,10,0),
                  alternateNodeSpacing: 20
                }),
           "undoManager.isEnabled": true // enable undo & redo
          });



      var pinkgrad = $(go.Brush, "Linear", { 0: "rgb(255, 0, 0)", 1: "rgb(255, 0, 0)" });
      function genderWidthConverter(id_image) {
             if (id_image === null) return 400;
             return 250;
            }
      // manage boss info manually when a node or link is deleted from the diagram
      myFullDiagram.addDiagramListener("SelectionDeleting", e => {
        var part = e.subject.first(); // e.subject is the myDiagram.selection collection,
        // so we'll get the first since we know we only have one selection
        myFullDiagram.startTransaction("clear boss");
        if (part instanceof go.Node) {
          var it = part.findTreeChildrenNodes(); // find all child nodes
          while (it.next()) { // now iterate through them and clear out the boss information
            var child = it.value;
            var bossText = child.findObject("boss"); // since the boss TextBlock is named, we can access it by name
            if (bossText === null) return;
            bossText.text = "";
          }
        } else if (part instanceof go.Link) {
          var child = part.toNode;
          var bossText = child.findObject("boss"); // since the boss TextBlock is named, we can access it by name
          if (bossText === null) return;
          bossText.text = "";
        }
        myFullDiagram.commitTransaction("clear boss");
      });

      var levelColors = ["#AC193D", "#2672EC", "#8C0095", "#5133AB",
        "#008299", "#D24726", "#008A00", "#094AB2"];

      // override TreeLayout.commitNodes to also modify the background brush based on the tree depth level
      myFullDiagram.layout.commitNodes = function() {
        go.TreeLayout.prototype.commitNodes.call(myFullDiagram.layout);  // do the standard behavior
        // then go through all of the vertexes and set their corresponding node's Shape.fill
        // to a brush dependent on the TreeVertex.level value
        myFullDiagram.layout.network.vertexes.each(v => {
          if (v.node) {
            var level = v.level % (levelColors.length);
            var color = levelColors[level];
            var shape = v.node.findObject("SHAPE");
            if (shape) shape.stroke = $(go.Brush, "Linear", { 0: color, 1: go.Brush.lightenBy(color, 0.05), start: go.Spot.Left, end: go.Spot.Right });
          }
        });
      };



      // this is used to determine feedback during drags


      // This function provides a common style for most of the TextBlocks.
      // Some of these values may be overridden in a particular TextBlock.
      function textStyle() {
        return { font: "8pt  Segoe UI,sans-serif", stroke: "black" };
      }

      // This converter is used by the Picture.
      function findHeadShot(id_image) {
        return "qrc:/image/Radar" + id_image + ".jpg";
      }
       function mayWorkFor(node1 , node2){
            if (!(node1 instanceof go.Node)) return false;
            if (node1===node2) return false;
            if (node2.isInTreeof(node1)) return false;
            return true
        }
      // define the Node template
       var nodeTemplate =
        $(go.Node, "Auto",
          { // handle dragging a Node onto a Node to (maybe) change the reporting relationship
          mouseDragEnter: (e, node, prev) => {
                        var diagram = node.diagram;
                        var selnode = diagram.selection.first();
                        if (!mayWorkFor(selnode, node)) return;
                        var shape = node.findObject("SHAPE");
                        if (shape) shape.fill = "darkred";
                      },
                      mouseDragLeave: (e, node, next) => {
                        var shape = node.findObject("SHAPE");
                        if (shape) shape.fill = graygrad;
                      },
                      mouseDrop: (e, node) => {
                        var diagram = node.diagram;
                        var selnode = diagram.selection.first();  // assume just one Node in selection
                        if (mayWorkFor(selnode, node)) {
                          // find any existing link into the selected node
                          var link = selnode.findTreeParentLink();
                          if (link !== null) {  // reconnect any existing link
                            link.fromNode = node;
                          } else {  // else create a new link
                            diagram.toolManager.linkingTool.insertLink(node, node.port, selnode, selnode.port);
                          }
                        }
                      }
          },
          // for sorting, have the Node.text be the data.name
          new go.Binding("text", "name"),
          // bind the Part.layerName to control the Node's layer depending on whether it isSelected
          new go.Binding("layerName", "isSelected", sel => sel ? "Foreground" : "").ofObject(),
          // define the node's outer shape
          $(go.Shape, "RoundedRectangle",
            {
                height: 100,
                width :150,
              name: "SHAPE", fill: pinkgrad, stroke: 'white', strokeWidth: 3.5,
              // set the port properties:
              portId: "" ,cursor: "pointer"
            },
            new go.Binding("width","id_image",genderWidthConverter),
             new go.Binding("fill", "color")),
          $(go.Panel, "Horizontal",
            $(go.Picture,
              {
                name: "Picture",
                desiredSize: new go.Size(50, 50),
                margin: 1.5,
              },
              new go.Binding("source", "id_image", findHeadShot)),
            // define the panel where the text will appear
            $(go.Panel, "Table",
              {
                minSize: new go.Size(130, NaN),
                maxSize: new go.Size(150, NaN),
                margin: new go.Margin(6, 10, 0, 6),
                defaultAlignment: go.Spot.Left
              },
              $(go.RowColumnDefinition, { column: 2, width: 4 }),
              $(go.TextBlock, textStyle(),  // the name
                {
                  row: 0, column: 0, columnSpan: 5,
                  font: "10pt Segoe UI,sans-serif",
                  editable: true, isMultiline: false,
                  minSize: new go.Size(10, 16)
                },
                new go.Binding("text", "name").makeTwoWay()),
              $(go.TextBlock, "Title: ", textStyle(),
                { row: 1, column: 0 }),
              $(go.TextBlock, textStyle(),
                {
                  row: 1, column: 1, columnSpan: 4,
                  editable: true, isMultiline: false,
                  minSize: new go.Size(10, 14),
                  margin: new go.Margin(0, 0, 0, 3)
                },
                new go.Binding("text", "title").makeTwoWay()),
              $(go.TextBlock, textStyle(),
                { row: 2, column: 0 },
                new go.Binding("text", "key", v => "ID: " + v)),
              $(go.TextBlock, textStyle(),
                { name: "boss", row: 2, column: 3, }, // we include a name so we can access this TextBlock when deleting Nodes/Links
                new go.Binding("text", "parent", v => "Boss: " + v)),
              $(go.TextBlock, textStyle(),  // the comments
                {
                  row: 3, column: 0, columnSpan: 5,
                  font: "italic 9pt sans-serif",
                  wrap: go.TextBlock.WrapFit,
                  editable: true,  // by default newlines are allowed
                  minSize: new go.Size(10, 14)
                },
                new go.Binding("text", "comments").makeTwoWay()),

            ),  // end Table Panel

            ), // end Horizontal Panel
             $("TreeExpanderButton",{alignment :go.Spot.Bottom})
        );  // end Node


        myFullDiagram.nodeTemplate = nodeTemplate;


      // the context menu allows users to make a position vacant,
      // remove a role and reassign the subtree, or remove a department
      myFullDiagram.nodeTemplate.contextMenu =
        $("ContextMenu",
          $("ContextMenuButton",
            $(go.TextBlock, "Vacate Position"),
            {
              click: (e, obj) => {
                var node = obj.part.adornedPart;
                if (node !== null) {
                  var thisemp = node.data;
                  myFullDiagram.startTransaction("vacate");
                  // update the key, name, and comments
                  myFullDiagram.model.setDataProperty(thisemp, "name", "(Vacant)");
                  myFullDiagram.model.setDataProperty(thisemp, "comments", "");
                  myFullDiagram.commitTransaction("vacate");
                }
              }
            }
          ),
          $("ContextMenuButton",
            $(go.TextBlock, "Remove Role"),
            {
              click: (e, obj) => {
                // reparent the subtree to this node's boss, then remove the node
                var node = obj.part.adornedPart;
                if (node !== null) {
                  myFullDiagram.startTransaction("reparent remove");
                  var chl = node.findTreeChildrenNodes();
                  // iterate through the children and set their parent key to our selected node's parent key
                  while (chl.next()) {
                    var emp = chl.value;
                    myFullDiagram.model.setParentKeyForNodeData(emp.data, node.findTreeParentNode().data.key);
                  }
                  // and now remove the selected node itself
                  myFullDiagram.model.removeNodeData(node.data);
                  myFullDiagram.commitTransaction("reparent remove");
                }
              }
            }
          ),
          $("ContextMenuButton",
            $(go.TextBlock, "Remove Department"),
            {
              click: (e, obj) => {
                // remove the whole subtree, including the node itself
                var node = obj.part.adornedPart;
                if (node !== null) {
                  myFullDiagram.startTransaction("remove dept");
                  myFullDiagram.removeParts(node.findTreeParts());
                  myFullDiagram.commitTransaction("remove dept");
                }
              }
            }
          )
        );
        // define the Link template
        myFullDiagram.linkTemplate =
          $(go.Link, go.Link.Orthogonal,
            { corner: 20 },
            $(go.Shape, { strokeWidth: 1.5, stroke: "#141B41" },
            new go.Binding("stroke", "colorlink")
            ));  // the link shape



      // support editing the properties of the selected person in HTML
      if (window.Inspector) myInspector = new Inspector("myInspector", myFullDiagram,
        {
          properties: {
            "key": { readOnly: true },
            "color": {readOnly:true},
            "id_image" : {readOnly: true},
            "name": { readOnly: true },
            "title": { readOnly: true },
            "parent": { readOnly: true },
            "colorlink": {readOnly: true},
            "comments": {}
          }
        });


      // read in the JSON-format data from the "mySavedModel" element


      // Setup zoom to fit button
      document.getElementById('zoomToFit').addEventListener('click', () => myFullDiagram.commandHandler.zoomToFit());

      document.getElementById('centerRoot').addEventListener('click', () => {
        myFullDiagram.scale = 1;
        myFullDiagram.commandHandler.scrollToPart(myFullDiagram.findNodeForKey(1));
      });
    } // end init
    function searchDiagram() {  // called by button
          var input = document.getElementById("mySearch");
          if (!input) return;
          myFullDiagram.focus();

          myFullDiagram.startTransaction("highlight search");

          if (input.value) {
            // search four different data properties for the string, any of which may match for success
            // create a case insensitive RegExp from what the user typed
            var safe = input.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            var regex = new RegExp(safe, "i");
            var results = myFullDiagram.findNodesByExample({ name: regex },
              { nation: regex },
              { title: regex },
              { headOf: regex });
            myFullDiagram.highlightCollection(results);
            // try to center the diagram at the first node that was found
            if (results.count > 0) myFullDiagram.centerRect(results.first().actualBounds);
          } else {  // empty string only clears highlighteds collection
            myFullDiagram.clearHighlighteds();
          }

          myFullDiagram.commitTransaction("highlight search");
        }

    window.addEventListener('DOMContentLoaded', init);
  </script>
<style>
input[type=search] {
  width: 80%;
  padding: 12px 20px;
  margin: 8px 0;
  box-sizing: border-box;
   border-radius:12px;
  border: 3px solid #CBA135;
  -webkit-transition: 0.5s;
  transition: 0.5s;
  outline: none;
}
    .btton {
        background-color:#CBA135;
        border:none;
        color:white;
        padding:15px 32px;
        text-align:Center;
        text-decoration:none;
        display:inline-block;
        font-Size: 12px;
        border-radius:12px;
        transition-duration:1s
    }
    .btton:hover{
        background-color:#FFFFFF;
        color:black;
        border:2px solid #CBA135;
        box-shadow: 0 12px 16px 0 rgba(84,92,82,0.80),0 17px 50px 0 rgba(76,175,80,0.19)

    }
</style>
<p id="nodeDataArray"></p>
<div id="sample">
  <div id="myDiagramDiv" style="background-color: rgb(136, 212, 152); border: 1px solid black; border-radius:12px;height: 570px; position: relative; cursor: auto;"><canvas tabindex="0" style="position: absolute; top: 0px; left: 0px; z-index: 2; user-select: none; touch-action: none; width: 1054px; height: 551px; cursor: auto;" width="1054" height="551">This text is displayed if your browser does not support the Canvas HTML element.</canvas><div style="position: absolute; overflow: auto; width: 1054px; height: 568px; z-index: 1;"><div style="position: absolute; width: 1687.5px; height: 1px;"></div></div></div>
  <p><button id="zoomToFit" class=btton>Zoom to Fit</button> <button id="centerRoot" class=btton>Center on root</button></p>
  <input id="mySearch" onkeypress="if (event.keyCode === 13) searchDiagram()" type="search">
  <button class=btton onclick="searchDiagram()">Search</button>
    <div>
    <div id="myInspector" class="inspector"></div>
  </div>


  </body>
  </html>
